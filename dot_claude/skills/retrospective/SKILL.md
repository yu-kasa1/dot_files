---
name: retrospective
description: 開発完了後にふりかえりを実施し、Keep/Problem/Tryで学びを構造化して記録する。
---

# ふりかえり (retrospective)

## 概要
機能開発の完了後に、設計〜実装〜レビューの一連の流れをふりかえり、
「何がうまくいったか」「何がうまくいかなかったか」「次に活かすべきこと」を構造化して記録する。
経験を次のプロジェクトに引き継ぐ**学習ループ**を担う。

## なぜ必要か
エージェントパイプラインは一方通行になりやすい。
requirement-definer → spec-writer → ... → doc-updater と流れて終わり。
「この仕様の書き方だとcoderが迷った」「このリスクは見落としていた」といった**プロセス自体の改善点**がどこにも記録されない。
このスキルがそれを拾い、次のプロジェクトの品質を上げる。

## 呼び出しタイミング
- **推奨**: 実装セッション内で `@doc-updater` 完了後に呼び出す（パイプラインの最終段）
- **任意**: 大きなバグ修正が完了した後
- **任意**: 途中で方針転換や手戻りが発生した後

### なぜ実装セッション内で呼ぶべきか
別セッションで呼ぶと、成果物（spec.md、tasks.md、git log）からしか情報を得られない。
実装セッション内であれば、**会話コンテキストにプロセス全体の経験が残っている**:
- どのタスクで迷ったか、なぜ迷ったか
- どこで手戻りが発生し、何が原因だったか
- ユーザーとのやり取りで方針が変わった箇所
- 仕様の曖昧さが問題になった具体的な瞬間

成果物だけでは「結果」しか見えないが、セッション内なら「過程」も含めてふりかえれる。

## 実行手順

### 1. 完了した作業の全体像を把握
まず**セッション内の会話コンテキスト**から、実装中に起きたことを思い出す:
- 実装がスムーズだったタスクと、難航したタスク
- ユーザーとのやり取りで認識齟齬が生じた箇所
- 途中で方針変更や手戻りが発生した箇所

次に、ドキュメント・履歴で事実を補完する:
- **spec.md**: 当初の仕様
- **tasks.md**: タスク一覧と進捗（完了状況、ステータス変遷）
- **git log**: 実際のコミット履歴（作業の流れ・手戻りの有無）
- **レビュー指摘**: code-reviewer / security-reviewer のレポート（もしあれば）
- **risk-analyzer レポート**: リスク分析結果（もしあれば）

### 2. 3つの問いでふりかえる
以下の問いに対して、具体的な事実に基づいて回答を整理する:

#### Keep: 何がうまくいったか？
- 仕様通りにスムーズに実装できた箇所とその理由
- 事前のリスク分析が役立った事例
- 設計判断が正しかったと確認できた箇所

#### Problem: 何がうまくいかなかったか？
- 手戻りが発生した箇所とその原因
- 仕様の曖昧さが実装時に問題になった箇所
- 見落としていたリスクや影響範囲
- 想定より時間がかかったタスクとその理由

#### Try: 次に何を変えるか？
- Keep/Problemから導かれる具体的な改善アクション
- エージェント定義やテンプレートの改善提案
- プロセスの改善提案

**重要**: 抽象的な感想（「コミュニケーションを密にする」等）ではなく、**具体的で再現可能なアクション**に落とし込む。

### 3. パターンの抽出
ふりかえりの結果から、再利用可能なパターンを抽出:

#### 成功パターン
- 「こうしたらうまくいった」という再現可能な手法
- 例: 「外部API連携時にタイムアウトのデフォルト値をspec.mdに明記したことで、実装時の迷いがなくなった」

#### 失敗パターン（アンチパターン）
- 「こうしたら失敗した」という回避すべき手法
- 例: 「ステータス遷移図なしで状態管理を実装したら、仕様漏れが3件発生した」

### 4. ナレッジベースへの記録
抽出したパターンを永続的に記録する:
- **記録先**: `~/.claude/retrospectives/{プロジェクト名}/` 配下
- **ファイル名**: `{YYYYMMDD}_{機能名またはブランチキー}.md`
- **蓄積**: 過去のふりかえりを読み返すことで、同じ失敗を繰り返さない

### 5. ユーザーへの報告
ふりかえり結果をユーザーに報告し、以下を確認:
- 認識の齟齬がないか
- Tryの中で実際にアクションするものはどれか
- エージェント定義の改善を反映するか

## 出力テンプレート

```markdown
# ふりかえりレポート

## 概要
- **対象機能**: {機能名}
- **仕様書**: {spec.mdへのパス}
- **期間**: {開始日} 〜 {完了日}
- **ふりかえり日時**: YYYY/MM/DD HH:MM

---

## Keep（うまくいったこと）

### K-1: {タイトル}
- **事実**: {何が起きたか}
- **なぜうまくいったか**: {成功の要因}
- **再現するには**: {次も同じ結果を得るための条件}

---

## Problem（うまくいかなかったこと）

### P-1: {タイトル}
- **事実**: {何が起きたか}
- **原因**: {なぜ起きたか}
- **影響**: {どの程度の手戻り・追加作業が発生したか}

---

## Try（次に試すこと）

### T-1: {タイトル}
- **関連**: {K-X / P-X}
- **アクション**: {具体的に何をするか}
- **適用範囲**: {次回以降すべてのプロジェクト / 特定条件のプロジェクト}
- **反映先**: {エージェント定義 / テンプレート / CLAUDE.md / プロセス}

---

## 抽出パターン

### 成功パターン
| No | パターン名 | 説明 | 適用条件 |
|----|-----------|------|---------|
| 1 | {名前} | {説明} | {いつ使うか} |

### 失敗パターン（アンチパターン）
| No | パターン名 | 説明 | 回避方法 |
|----|-----------|------|---------|
| 1 | {名前} | {説明} | {どうすれば避けられるか} |

---

## 数値サマリー（参考）
| 項目 | 値 |
|------|-----|
| タスク総数 | {N} |
| 手戻りが発生したタスク | {N} |
| レビュー指摘数（Critical/Major） | {N} |
| リスク分析で事前に検出できたもの | {N} |
| リスク分析で見落としていたもの | {N} |

---

## 次のステップ
- [ ] ユーザーによるTryの取捨選択
- [ ] 採用されたTryのエージェント定義・テンプレートへの反映
- [ ] ナレッジベースへの保存
```

## 注意事項
- ふりかえりは**犯人探し・責任追及の場ではない**。「なぜうまくいかなかったか」の分析は、プロセス改善のためであり、誰かを責めるためではない
- 抽象的な改善案（「もっと注意する」「コミュニケーションを増やす」）は意味がない。**具体的で検証可能なアクション**に変換すること
- すべてのProblemにTryが必要なわけではない。「今回は特殊なケースだった」と判断できるものは記録だけで良い
- 過去のふりかえり（`~/.claude/retrospectives/`）を参照し、**同じProblemが繰り返し出ていないか**確認する。繰り返しているなら、前回のTryが機能していない可能性がある
- ふりかえりの所要時間は短く。長大なレポートを書くことが目的ではなく、**次に活かせるアクションを1つでも見つけること**が目的
- **Tryは最大3つに絞る**。「全部やる」は「何もやらない」と同義

## アンチパターン（これをやったら失敗）

### 1. 感想文ライター
**症状**: 「全体的にうまくいったと思います」「もう少し早く着手すればよかったです」のような感想を並べる。
**結果**: 次のプロジェクトで何も変わらない。
**対策**: Keep/Problem/Tryすべてに**具体的な事実（ファイル名、タスクID、コミットハッシュ等）**を含めること。事実がないものは書かない。

### 2. 改善案量産マシン
**症状**: Tryを10個以上書き出し、すべてを次回に適用しようとする。
**結果**: どれも中途半端になるか、全部忘れる。
**対策**: Tryは**最大3つ**に絞る。最もインパクトが大きいものを選ぶ。「全部やる」は「何もやらない」と同義。

### 3. 自己完結クローザー
**症状**: ユーザーに確認せず、自分でKeep/Problem/Tryを決めてレポートを完成させる。
**結果**: ユーザーの実感と乖離したふりかえりになる。採用されない改善案が量産される。
**対策**: 特にProblemとTryは**ユーザーの実感を必ず確認**する。エージェントが気づかなかった問題をユーザーは感じている可能性がある。
